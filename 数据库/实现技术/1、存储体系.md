### 存储体系
<img src="https://img-blog.csdnimg.cn/20201127092823897.png?" width="80%"/>


#### 磁盘块

* 磁盘块是每次 IO 的最小单位，和内存中一个页的大小相同



磁盘块间连系方法（不同的文件组织方式，会使用不同的组织方式，通常会多种结合）

* 连续分配: 数据块被分配到连续的磁盘块上(会存在扩展困难问题)
* 链接分配: 数据块中包含指向下一数据块的指针(访问速度问题)
* 按簇分配: 按簇分配，簇是若干连续的磁盘块，簇之间靠指针连接;簇有时也称片段Segment或盘区extent
* 索引分配: 索引块中存放指向实际数据块的指针



块中的记录

* 定长记录，还是变长记录

  * 定长

	<img src="https://img-blog.csdnimg.cn/20201127092843307.png" width="50%" height="50%" />

    

  * 变长（靠分隔符区分开始与结束）
	<img src="https://img-blog.csdnimg.cn/20201127092918286.png" width="50%" height="50%" />
    


    

  * 因为每次加载到内存的都是一个数据块，所以要通过块头进行查找：块头（块内指针，即表目录、行目录）
    
	<img src="https://img-blog.csdnimg.cn/20201127092932328.png" width="50%" height="50%" />
	




* 记录是非跨块存储，还是跨块存储（指块的大小不够时）

  * 非跨块
	<img src="https://img-blog.csdnimg.cn/20201127092950872.png" width="50%" height="50%" />
  * 跨块
	<img src="https://img-blog.csdnimg.cn/20201127093005712.png?" width="50%" height="50%" />




#### 文件组织

* 文件主要有两种：索引文件、主文件



数据组织要考虑更新(增、删、改)和检索需求

* 更新将涉及数据存储空间的扩展与回收问题
* 检索将涉及扫描整个数据库的问题、大批量处理数据问题
* 不同的需求要求不同的数据组织方法和存取方法



文件组织(File Organization)

* 指的是数据组织成记录、块和访问结构的方式，包括**把记录和块存储在磁盘上的方式，以及记录和块之间相互联系的方法**
* 文件组织方式不同，磁盘块的联系方式也有不同

存取方法(Access Method)

* 指的是对文件所采取的存取操作方法
* 一种文件组织可以采取多种存取方法进行访问



文件组织方法

* 方法之一：无序记录文件(堆文件heap或pile file)

  * 特点：记录可存储于任意有空间的位置，磁盘上存储的记录是无序的。更新效率高，但检索效率可能低

  * 方法1：新记录总插入到文件尾部；删除记录时，可以直接删除该记录所在位置的内容，也可以在该记录前标记“删除标记”

	<img src="https://img-blog.csdnimg.cn/20201127093019735.png?" width="30%" height="30%" />

  * 方法2：在前者基础上，新增记录可以利用那些标记为“删除标记”的记录空间

  	<img src="https://img-blog.csdnimg.cn/20201127093039516.png?" width="30%" height="50%" />


  * 缺点

    * 频繁删增记录时会造成空间浪费，所以需要周期性重新组织数据库
    * 数据库重组(Reorganization)是通过移走被删除的记录使有效记录连续存放，从而回收那些由删除记录而产生的未利用空间。



* 方法之二：有序记录文件(排序文件Sequential)

  * 特点：记录按某属性或属性组值的顺序插入，磁盘上存储的记录是有序的。检索效率可能高。

    * 用于存储排序的属性通常称为排序字段(Orderingfield)，通常，排序字段使用关系中的主码， 所以又称排序码(Orderingkey)
    * 当按排序字段进行检索时，速度得到很大提高；但当按非排序字段检索时，速度可能不会提高很多
    * 有序记录文件的更新效率可能很低，因为在更新时要移动其他记录，为插入记录留出空间

  * 改进措施

    * 为将来有可能插入的元组预留空间(这可能造成空间浪费),或者再使用一个临时的无序文件(被称为溢出文件)保留新增的记录。
    * 当采取溢出文件措施时，检索操作既要操作主文件，又要操作溢出文件。
    * 所以需要周期性重新组织数据库
    * 数据库重组是将溢出文件合并到主文件中，并恢复主文件中的记录顺序。

   


	<img src="https://img-blog.csdnimg.cn/20201127093053348.png" width="50%" height="50%" />

* 方法之三：散列文件(Hash file)

  * 特点：可以把记录按某属性或属性组的值,依据一个散列函数来计算其应存放的位置：桶号(Bucket,块号或簇号等)。

    * 检索效率和更新效率都有一定程度的提高
    * 用于进行散列函数计算的属性通常称为散列字段(Hashfield)，散列字段通常也采用关系中的主码，所以又称散列码(hashkey)

  * 不同记录可能被hash成同一桶号，此时需在桶内顺序检索出某一记录

	<img src="https://img-blog.csdnimg.cn/20201127093107918.png" width="50%" height="50%" />
    
	<img src="https://img-blog.csdnimg.cn/20201127093121496.png?" width="50%" height="50%" />

  * 链接法处理溢出

 

	<img src="https://img-blog.csdnimg.cn/20201127093136119.png?" width="50%" height="50%" />




* 方法之四：聚簇文件(Clustering file)
  * 聚簇：将具有相同或相似属性值的记录存放于连续的磁盘簇块中
  * 多表聚簇：将若干个相互关联的Table存储于一个文件中—这可提高多表情况下的查询速度



#### Oracle DB 

Oracle数据库组织为

* 数据库(database)、表空间(tablespace)、操作系统文件、table、段(segment)、盘区(extent)和基本数据块(data blocks)


	
	<img src="https://img-blog.csdnimg.cn/20201127093149576.png" width="50%" height="50%" />


逻辑存储层

* 每个数据库分成一个或多个表空间，所有表空间的组合存储容量即是数据库的存储容量
* 有系统表空间SYSTEM和用户表空间；系统表空间由Oracle在创建数据库时自动创建，用于数据字典等的管理；用户表空间可由用户创建
* 每个表空间由一个或多个操作系统文件构成,一个操作系统文件只能与一个数据库相联，操作系统文件仅起占位的作用。数据在表空间中可跨文件进行操作。
* 操作系统文件中存储一个表(Table)或多个表，一个表可存储在一个文件中也可能存储在多个文件中。



物理存储

* 物理存储层由段(segment)、盘区(extent)和数据块(datablock)构成
* 数据块是最小的IO存储单位，又称为Oracle块、页(相当于扇区)
* 盘区是特定数量的连续数据块(相当于簇)。Oracle中的盘区是可以动态变化的，随不同数据库存储需求而调整
* 段是一组分配了特定数据结构的盘区，又分为数据段、索引段和临时段等
* 一个表的数据可以存放在一个段内，也可以存放在多个段内。一个段可以存放一个表的数据，也可以存放多个表的数据(如聚簇文件) 
